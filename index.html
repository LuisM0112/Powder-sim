<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Powder</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üèîÔ∏è</text></svg>">

  <style>
    :root {
      color-scheme: light dark;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      user-select: none;
    }

    .flex {
      display: flex;
      gap: 5px;
      justify-content: center;
      align-items: center;
    }

    body {
      flex-direction: column;
      height: 100dvh;
    }

    #game {
      width: 800px;
      height: 600px;
    }

    #material-radio-container {
      border: 1px solid white;
      padding: 5px;
    }

    legend {
      font-size: large;
      padding: 5px;
      font-weight: bold;
    }

    #reset-btn {
      height: fit-content;
      width: fit-content;
      padding: 10px;
    }
  </style>

  <script type="module">

    import { Material, Void, Metal, StoneLike, SandLike, WaterLike } from "./class/material.js"
    import { Grid } from "./class/grid.js"
    import { Cell } from "./class/cell.js"

    const $ = (element) => document.querySelector(element)
    
    const canvas = $('#game')
    const materialRadioContainer = $('#material-radio-container')
    const materialRadioTemplate = $('#material-radio-template')
    const resetBtn = $('#reset-btn')
    const ctx = canvas.getContext('2d')

    const game = {
      x: 0,
      y: 0,
      width: canvas.width,
      height: canvas.height,
    }

    let animationFrameID = null

    const cell = new Cell({
      X: 0,
      y: 0,
      width: 10,
      height: 10,
      material: new Void()
    })

    let grid = new Grid(game, cell)

    const mouse = {
      x: 0,
      y: 0,
      isDrawing: false
    }

    const MATERIALS = {
      VOID: new Void(),
      Metal: new Metal(),
      STONE: new StoneLike(),
      SAND: new SandLike(),
      WATER: new WaterLike(),
    }

    let selectedMaterial = MATERIALS.VOID

    function handleDrawing(row, col, grid, material) {
      if (!mouse.isDrawing) return
      if (row == null || col == null) return
      const cell = grid.grid[row][col]
      if (cell.material == selectedMaterial) return
      cell.material = material
    }

    function drawGrid(grid) {
      for (let row = 0; row < grid.rows; row++) {
        for (let col = 0; col < grid.cols; col++) {
          const cell = grid.grid[row][col]
          ctx.fillStyle = cell.material.color
          ctx.fillRect(cell.x, cell.y, cell.width, cell.height)
        }
      }
    }

    function moveCells(grid) {
      for (let row = grid.rows - 1; row >= 0; row--) {
        if (row % 2 === 0) {
          for (let col = 0; col < grid.cols; col++) {
            const cell = grid.grid[row][col]
            if (cell.material.move) cell.material.move(cell, grid)
          }
        } else {
          for (let col = grid.cols - 1; col >= 0; col--) {
            const cell = grid.grid[row][col]
            if (cell.material.move) cell.material.move(cell, grid)
          }
        }
      }
    }

    function drawHighlight(row, col, grid) {
      if (row == null || col == null) return
      const cell = grid.grid[row][col]
      const [r, g, b] = cell.material.color.match(/\d+/g).map(channel => Math.min(255, +channel + 40))
      ctx.fillStyle = `rgb(${r},${g},${b})`
      ctx.fillRect(cell.x, cell.y, cell.width, cell.height)
    }

    function clearElement(element) {
      ctx.clearRect(element.x, element.y, element.width, element.height)
    }

    function addMaterialRadioButtons(materials) {
      Object.entries(materials).forEach(([key, value]) => {
        const clone = materialRadioTemplate.content.cloneNode(true)
        const input = clone.querySelector("input")
        const label = clone.querySelector(".label-text")

        input.value = key
        label.textContent = key
        input.addEventListener("change", () => {
          selectedMaterial = MATERIALS[key]
        })
        materialRadioContainer.appendChild(clone)
      });
    }
    

    resetBtn.addEventListener('click', start)

    canvas.addEventListener('mousemove', (event) => {
      mouse.x = event.offsetX
      mouse.y = event.offsetY
    })

    canvas.addEventListener('mousedown', (event) => {
      mouse.isDrawing = true
    })

    canvas.addEventListener('mouseup', (event) => {
      if (mouse.isDrawing) {
        mouse.isDrawing = false
      }
    })

    function stop() {
      if (animationFrameID == null) return
      window.cancelAnimationFrame(animationFrameID)
      animationFrameID = null
    }

    function start() {
      stop()
      grid = new Grid(game, cell)
      animationFrameID = window.requestAnimationFrame(process)
    }

    function process() {

      clearElement(game)
      drawGrid(grid)

      moveCells(grid)
      const mousePos = grid.getCellPos(mouse.x, mouse.y)

      if (mousePos) {
        drawHighlight(mousePos.row, mousePos.col, grid)
        handleDrawing(mousePos.row, mousePos.col, grid, selectedMaterial)
      }

      animationFrameID = window.requestAnimationFrame(process)
    }
    addMaterialRadioButtons(MATERIALS)
    start()
    
  </script>
</head>
<body class="flex">
   <template id="material-radio-template">
    <label>
      <input type="radio" name="materials" value=""/>
      <span class="label-text"></span>
    </label>
    <br>
  </template>
  <canvas id="game" width="800" height="600"></canvas>
  <section id="menu" class="flex">
    <fieldset id="material-radio-container" class="flex">
      <legend>Material list:</legend>
    </fieldset>
    <input type="reset" id="reset-btn" name="reset" value="Reset">
  </section>
</body>
</html>
